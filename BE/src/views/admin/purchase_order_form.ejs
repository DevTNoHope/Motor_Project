<h1 class="text-2xl font-semibold mb-4"><%= formTitle %></h1>

<form action="<%= formAction %>" method="POST" class="bg-white p-6 rounded shadow space-y-4">
  <% if (method === 'PATCH') { %>
    <input type="hidden" name="_method" value="PATCH">
  <% } %>

  <% const isReadOnly = po?.status === 'RECEIVED'; %>

  <div>
    <label class="block mb-1 font-medium">Nh√† cung c·∫•p</label>
    <select name="supplier_id" required class="border p-2 rounded w-full" <%= isReadOnly ? 'disabled' : '' %>>
      <option value="">-- Ch·ªçn nh√† cung c·∫•p --</option>
      <% suppliers.forEach(s => { %>
        <option value="<%= s.id %>" <%= po?.supplier_id === s.id ? 'selected' : '' %>><%= s.name %></option>
      <% }) %>
    </select>
  </div>

 <!-- ‚úÖ Ghi ch√∫ s·ª≠ d·ª•ng CKEditor 5 -->
<div>
  <label class="block mb-1 font-medium">Ghi ch√∫</label>

  <% if (isReadOnly) { %>
    <!-- üîç Hi·ªÉn th·ªã HTML th·∫≠t khi phi·∫øu ƒë√£ nh·∫≠n -->
    <div class="border p-3 rounded bg-gray-50 min-h-[120px] prose">
      <%- po?.note || '<em>Kh√¥ng c√≥ ghi ch√∫</em>' %>
    </div>
  <% } else { %>
    <!-- üìù Khi c√≤n ·ªü ch·∫ø ƒë·ªô ch·ªânh s·ª≠a, d√πng CKEditor -->
    <textarea name="note" id="editor" class="border p-2 rounded w-full"><%= po?.note || '' %></textarea>
  <% } %>
</div>

  <% if (po?.status) { %>
    <p class="text-sm text-slate-500">
      Tr·∫°ng th√°i: 
      <span class="<%= po.status === 'RECEIVED' ? 'text-emerald-600' : 'text-amber-600' %> font-semibold">
        <%= po.status %>
      </span>
    </p>
  <% } %>

  <hr>

<div>
  <label class="block font-medium mb-2">Danh s√°ch ph·ª• t√πng nh·∫≠p</label>
  <div id="items">
    <% (po?.PurchaseOrderItems || [{}]).forEach((item, idx) => { %>
      <div class="grid grid-cols-4 gap-2 mb-2 item-row">
        <select name="items[<%= idx %>][part_id]" class="border p-2 rounded part-select" required <%= isReadOnly ? 'disabled' : '' %>>
          <option value="">-- Ch·ªçn ph·ª• t√πng --</option>
          <% parts.forEach(p => { %>
            <option value="<%= p.id %>" <%= item.part_id === p.id ? 'selected' : '' %>><%= p.name %></option>
          <% }) %>
        </select>

        <input type="number" name="items[<%= idx %>][qty]" 
               value="<%= item.qty || 1 %>" class="border p-2 rounded" placeholder="S·ªë l∆∞·ª£ng" min="1"
               <%= isReadOnly ? 'readonly' : '' %>>

        <input type="number" name="items[<%= idx %>][cost_price]" 
               value="<%= item.cost_price || '' %>" class="border p-2 rounded" placeholder="Gi√° nh·∫≠p"
               <%= isReadOnly ? 'readonly' : '' %>>

        <% if (!isReadOnly) { %>
          <button type="button" class="remove-item bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200">üóë</button>
        <% } %>
      </div>
    <% }) %>
  </div>

  <% if (!isReadOnly) { %>
    <button type="button" id="addItem" 
            class="mt-2 px-3 py-1 bg-emerald-100 rounded text-emerald-700 hover:bg-emerald-200">
      + Th√™m ph·ª• t√πng
    </button>
  <% } %>
</div>


  <div class="flex gap-3 mt-6">
    <% if (!isReadOnly) { %>
      <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700">
        L∆∞u
      </button>
    <% } %>
    <a href="/admin/purchase-orders" class="px-4 py-2 rounded border hover:bg-slate-100">Quay l·∫°i</a>
  </div>
</form>

<% if (!isReadOnly) { %>
<script>
  // üö´ Kh√¥ng cho ch·ªçn tr√πng ph·ª• t√πng
  function refreshOptions() {
    const selectedIds = Array.from(document.querySelectorAll('.part-select'))
      .map(sel => sel.value)
      .filter(v => v);
    document.querySelectorAll('.part-select').forEach(sel => {
      Array.from(sel.options).forEach(opt => {
        if (opt.value && selectedIds.includes(opt.value) && opt.value !== sel.value) {
          opt.disabled = true;
        } else {
          opt.disabled = false;
        }
      });
    });
  }

  // ‚ûï Th√™m d√≤ng m·ªõi
  document.getElementById('addItem')?.addEventListener('click', () => {
    const container = document.getElementById('items');
    const idx = container.querySelectorAll('.item-row').length;
    const div = document.createElement('div');
    div.className = 'grid grid-cols-4 gap-2 mb-2 item-row';
    div.innerHTML = `
      <select name="items[${idx}][part_id]" class="border p-2 rounded part-select" required>
        <option value="">-- Ch·ªçn ph·ª• t√πng --</option>
        <% parts.forEach(p => { %>
          <option value="<%= p.id %>"><%= p.name %></option>
        <% }) %>
      </select>
      <input type="number" name="items[${idx}][qty]" value="1" class="border p-2 rounded" min="1">
      <input type="number" name="items[${idx}][cost_price]" class="border p-2 rounded" placeholder="Gi√° nh·∫≠p">
      <button type="button" class="remove-item bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200">üóë</button>
    `;
    container.appendChild(div);
    refreshOptions();
  });

  // ‚ùå X√≥a d√≤ng
  document.addEventListener('click', e => {
    if (e.target.classList.contains('remove-item')) {
      e.target.closest('.item-row').remove();
      refreshOptions();
    }
  });

  // üîÅ L√†m m·ªõi khi thay ƒë·ªïi ch·ªçn ph·ª• t√πng
  document.addEventListener('change', e => {
    if (e.target.classList.contains('part-select')) refreshOptions();
  });

  // Kh·ªüi t·∫°o
  refreshOptions();
</script>
<!-- ‚úÖ CKEditor 5 cho ghi ch√∫ -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
<script>
  ClassicEditor.create(document.querySelector('#editor'), {
    toolbar: [
      'heading', '|', 'bold', 'italic', 'underline', 'link',
      '|', 'bulletedList', 'numberedList', 'blockQuote',
      '|', 'undo', 'redo'
    ],
    placeholder: 'Nh·∫≠p ghi ch√∫ cho phi·∫øu nh·∫≠p h√†ng...',
  }).catch(error => console.error('CKEditor init error:', error));
</script>
<% } %>

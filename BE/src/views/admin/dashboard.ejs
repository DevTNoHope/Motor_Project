<div class="space-y-8">
  <div class="flex items-center justify-between"></div>

  <!-- Quick Stats -->
  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">Thá»£ sá»­a xe</span>
      <span class="text-2xl font-semibold text-emerald-600"
        ><%= stats.mechanics %></span
      >
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">Dá»‹ch vá»¥</span>
      <span class="text-2xl font-semibold text-indigo-600"
        ><%= stats.services %></span
      >
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">Phá»¥ tÃ¹ng</span>
      <span class="text-2xl font-semibold text-amber-600"
        ><%= stats.parts %></span
      >
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">Loáº¡i phá»¥ tÃ¹ng</span>
      <span class="text-2xl font-semibold text-purple-600"
        ><%= stats.partTypes %></span
      >
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">NhÃ  cung cáº¥p</span>
      <span class="text-2xl font-semibold text-pink-600"
        ><%= stats.suppliers %></span
      >
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">Phiáº¿u nháº­p hÃ ng</span>
      <span class="text-2xl font-semibold text-lime-600"
        ><%= stats.purchaseOrders %></span
      >
    </div>
  </div>

  <!-- ===================== THá»NG KÃŠ NÃ‚NG CAO ===================== -->
  <h2 class="text-xl font-semibold mt-10">Thá»‘ng kÃª hoáº¡t Ä‘á»™ng</h2>

  <!-- Advanced Stats -->
  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">Tá»•ng sá»‘ Ä‘Æ¡n</span>
      <span class="text-2xl font-semibold text-emerald-700"
        ><%= advanced.totalBookings %></span
      >
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">Tá»•ng doanh thu</span>
      <span class="text-2xl font-semibold text-blue-700">
        <%= (advanced.totalRevenue || 0).toLocaleString() %> â‚«
      </span>
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">ÄÆ¡n hoÃ n thÃ nh</span>
      <span class="text-2xl font-semibold text-purple-700"
        ><%= advanced.completedBookings %></span
      >
    </div>
  </div>

  <!-- ===================== BIá»‚U Äá»’ THá»NG KÃŠ DOANH THU ===================== -->
  <div class="bg-white shadow rounded-xl p-6 mt-8">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <h3 class="text-lg font-semibold">Biá»ƒu Ä‘á»“ thá»‘ng kÃª doanh thu</h3>

      <!-- Selector cháº¿ Ä‘á»™ xem -->
      <div class="flex flex-wrap gap-2 text-sm">
        <button
          type="button"
          class="chart-mode-btn px-3 py-2 rounded bg-slate-100 hover:bg-slate-200"
          data-mode="daily"
          onclick="handleModeClick('daily')"
        >
          NgÃ y
        </button>

        <button
          type="button"
          class="chart-mode-btn px-3 py-2 rounded bg-slate-100 hover:bg-slate-200"
          data-mode="weekly"
          onclick="handleModeClick('weekly')"
        >
          Tuáº§n
        </button>

        <button
          type="button"
          class="chart-mode-btn px-3 py-2 rounded bg-slate-100 hover:bg-slate-200"
          data-mode="monthly"
          onclick="handleModeClick('monthly')"
        >
          ThÃ¡ng
        </button>

        <button
          type="button"
          class="chart-mode-btn px-3 py-2 rounded bg-slate-100 hover:bg-slate-200"
          data-mode="quarterly"
          onclick="handleModeClick('quarterly')"
        >
          QuÃ½
        </button>
      </div>
    </div>

    <!-- Bá»™ lá»c khoáº£ng ngÃ y tuá»³ chá»‰nh -->
    <div class="flex flex-wrap gap-4 items-end mt-4">
      <div>
        <label class="block mb-1 text-sm font-medium">Tá»« ngÃ y</label>
        <input type="date" id="fromDate" class="border p-2 rounded" />
      </div>

      <div>
        <label class="block mb-1 text-sm font-medium">Äáº¿n ngÃ y</label>
        <input type="date" id="toDate" class="border p-2 rounded" />
      </div>

      <button
        type="button"
        onclick="applyRangeFilter()"
        class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700"
      >
        Xem theo khoáº£ng
      </button>
    </div>

    <!-- Biá»ƒu Ä‘á»“ -->
    <canvas id="statChart" height="100" class="mt-6"></canvas>

    <!-- Tá»•ng káº¿t -->
    <div id="chartSummary" class="mt-6 text-lg text-slate-700 font-semibold">
      Äang táº£i dá»¯ liá»‡u...
    </div>
  </div>

  <!-- Top Services (giá»¯ nguyÃªn khá»‘i cÅ©) -->
  <div class="bg-white shadow rounded-xl p-6 mt-8">
    <h3 class="text-lg font-semibold mb-4">
      Top 5 dá»‹ch vá»¥ Ä‘Æ°á»£c Ä‘áº·t nhiá»u nháº¥t
    </h3>

    <ul class="divide-y">
      <% if (advanced.topServices && advanced.topServices.length) { %> <%
      advanced.topServices.forEach(function(s) { %>
      <li class="flex justify-between py-2">
        <span><%= s.name %></span>
        <span class="font-semibold"><%= s.total %> lÆ°á»£t</span>
      </li>
      <% }); %> <% } else { %>
      <p class="text-sm text-slate-500">ChÆ°a cÃ³ dá»¯ liá»‡u.</p>
      <% } %>
    </ul>
  </div>

  <!-- Footer -->
  <div class="text-center text-sm text-slate-500 mt-8">
    <p>ğŸš— Há»‡ thá»‘ng quáº£n lÃ½ cá»­a hÃ ng sá»­a xe mÃ¡y</p>
    <p class="mt-1">Â© 2025 - Äá»“ Ã¡n chuyÃªn ngÃ nh</p>
  </div>
</div>

<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  let statChart = null;
  let currentMode = "monthly";

  function setActiveButton(mode) {
    const buttons = document.querySelectorAll(".chart-mode-btn");
    buttons.forEach((btn) => {
      if (btn.dataset.mode === mode) {
        btn.classList.remove("bg-slate-100", "text-slate-800");
        btn.classList.add("bg-emerald-600", "text-white");
      } else {
        btn.classList.add("bg-slate-100", "text-slate-800");
        btn.classList.remove("bg-emerald-600", "text-white");
      }
    });
  }

  async function fetchChart(mode, extraParams = {}) {
    const params = new URLSearchParams({ mode });

    if (mode === "range") {
      if (!extraParams.from || !extraParams.to) {
        alert("Vui lÃ²ng chá»n Ä‘á»§ ngÃ y báº¯t Ä‘áº§u vÃ  káº¿t thÃºc!");
        return null;
      }
      params.set("from", extraParams.from);
      params.set("to", extraParams.to);
    }

    const res = await fetch(`/api/v1/admin/stats/chart?` + params.toString());
    if (!res.ok) {
      console.error("Fetch chart error", await res.text());
      return null;
    }
    return res.json();
  }

  function renderChart(labels, values) {
    const ctx = document.getElementById("statChart").getContext("2d");

    if (statChart) {
      statChart.destroy();
    }

    statChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: "Doanh thu (â‚«)",
            data: values,
            borderWidth: 3,
            tension: 0.3,
          },
        ],
      },
    });
  }

  function updateSummary(count, revenue) {
    const el = document.getElementById("chartSummary");
    el.innerHTML = `
      ğŸ“Œ Sá»‘ Ä‘Æ¡n: <b>${count}</b><br>
      ğŸ’° Doanh thu: <b>${Number(revenue || 0).toLocaleString()} â‚«</b>
    `;
  }

  async function handleModeClick(mode) {
    currentMode = mode;
    setActiveButton(mode);

    const data = await fetchChart(mode);
    if (!data) return;

    renderChart(data.labels, data.values);
    updateSummary(data.count, data.revenue);
  }

  async function applyRangeFilter() {
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;

    const data = await fetchChart("range", { from, to });
    if (!data) return;

    // Khi dÃ¹ng khoáº£ng ngÃ y, khÃ´ng Ä‘á»•i currentMode / nÃºt active
    renderChart(data.labels, data.values);
    updateSummary(data.count, data.revenue);
  }

  // Load máº·c Ä‘á»‹nh theo thÃ¡ng
  document.addEventListener("DOMContentLoaded", () => {
    handleModeClick("monthly");
  });
</script>

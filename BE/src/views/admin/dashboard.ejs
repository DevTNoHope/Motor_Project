<div class="space-y-8">

  <div class="flex items-center justify-between"></div>

  <!-- Quick Stats -->
  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">Th·ª£ s·ª≠a xe</span>
      <span class="text-2xl font-semibold text-emerald-600"><%= stats.mechanics %></span>
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">D·ªãch v·ª•</span>
      <span class="text-2xl font-semibold text-indigo-600"><%= stats.services %></span>
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">Ph·ª• t√πng</span>
      <span class="text-2xl font-semibold text-amber-600"><%= stats.parts %></span>
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">Lo·∫°i ph·ª• t√πng</span>
      <span class="text-2xl font-semibold text-purple-600"><%= stats.partTypes %></span>
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">Nh√† cung c·∫•p</span>
      <span class="text-2xl font-semibold text-pink-600"><%= stats.suppliers %></span>
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">Phi·∫øu nh·∫≠p h√†ng</span>
      <span class="text-2xl font-semibold text-lime-600"><%= stats.purchaseOrders %></span>
    </div>

  </div>


  <!-- ===================== TH·ªêNG K√ä N√ÇNG CAO ===================== -->
  <h2 class="text-xl font-semibold mt-10">Th·ªëng k√™ ho·∫°t ƒë·ªông</h2>

  <!-- Advanced Stats -->
  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">T·ªïng s·ªë ƒë∆°n</span>
      <span class="text-2xl font-semibold text-emerald-700"><%= advanced.totalBookings %></span>
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">T·ªïng doanh thu</span>
      <span class="text-2xl font-semibold text-blue-700">
        <%= (advanced.totalRevenue || 0).toLocaleString() %> ‚Ç´
      </span>
    </div>

    <div class="bg-white shadow rounded-xl p-4 flex flex-col items-start">
      <span class="text-slate-500 text-sm">ƒê∆°n ho√†n th√†nh</span>
      <span class="text-2xl font-semibold text-purple-700"><%= advanced.completedBookings %></span>
    </div>

  </div>


  <!-- Revenue Chart -->
  <div class="bg-white shadow rounded-xl p-6 mt-8">
    <h3 class="text-lg font-semibold mb-4">Doanh thu theo th√°ng</h3>
    <canvas id="revenueChart" height="100"></canvas>
  </div>


  <!-- Top Services -->
  <div class="bg-white shadow rounded-xl p-6 mt-8">
    <h3 class="text-lg font-semibold mb-4">Top 5 d·ªãch v·ª• ƒë∆∞·ª£c ƒë·∫∑t nhi·ªÅu nh·∫•t</h3>

    <ul class="divide-y">
      <% if (advanced.topServices && advanced.topServices.length) { %>
        <% advanced.topServices.forEach(function(s) { %>
          <li class="flex justify-between py-2">
            <span><%= s.name %></span>
            <span class="font-semibold"><%= s.total %> l∆∞·ª£t</span>
          </li>
        <% }); %>
      <% } else { %>
        <p class="text-sm text-slate-500">Ch∆∞a c√≥ d·ªØ li·ªáu.</p>
      <% } %>
    </ul>
  </div>
<!-- ===================== TH·ªêNG K√ä THEO NG√ÄY ===================== -->
<div class="bg-white shadow rounded-xl p-6 mt-10">
  <h3 class="text-lg font-semibold mb-4">Th·ªëng k√™ theo ng√†y / kho·∫£ng ng√†y</h3>

  <form id="filterForm" class="flex flex-wrap gap-4 items-end">

    <div>
      <label class="block mb-1 text-sm font-medium">T·ª´ ng√†y</label>
      <input type="date" id="fromDate" class="border p-2 rounded">
    </div>

    <div>
      <label class="block mb-1 text-sm font-medium">ƒê·∫øn ng√†y</label>
      <input type="date" id="toDate" class="border p-2 rounded">
    </div>

    <button type="button"
            onclick="loadRangeStats()"
            class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">
      Xem th·ªëng k√™
    </button>

    <!-- Preset buttons -->
    <div class="flex gap-2 ml-4">
      <button type="button" onclick="presetRange('today')" class="px-3 py-2 bg-slate-100 rounded hover:bg-slate-200 text-sm">
        H√¥m nay
      </button>
      <button type="button" onclick="presetRange('week')" class="px-3 py-2 bg-slate-100 rounded hover:bg-slate-200 text-sm">
        Tu·∫ßn n√†y
      </button>
      <button type="button" onclick="presetRange('month')" class="px-3 py-2 bg-slate-100 rounded hover:bg-slate-200 text-sm">
        Th√°ng n√†y
      </button>
      <button type="button" onclick="presetRange('quarter')" class="px-3 py-2 bg-slate-100 rounded hover:bg-slate-200 text-sm">
        Qu√Ω n√†y
      </button>
    </div>

  </form>

  <!-- K·∫øt qu·∫£ -->
  <div id="rangeResult" class="mt-6 text-lg text-slate-700 font-semibold">
    Ch∆∞a c√≥ d·ªØ li·ªáu.
  </div>
</div>
<script>
async function loadRangeStats() {
  const from = document.getElementById("fromDate").value;
  const to   = document.getElementById("toDate").value;

  if (!from || !to) {
    alert("Vui l√≤ng ch·ªçn ƒë·ªß ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c!");
    return;
  }

  const res = await fetch(`/api/v1/admin/stats/range?from=${from}&to=${to}`);
  const data = await res.json();

  document.getElementById("rangeResult").innerHTML = `
    <p>üìå S·ªë ƒë∆°n: <b>${data.count}</b></p>
    <p>üí∞ Doanh thu: <b>${data.revenue.toLocaleString()} ‚Ç´</b></p>
  `;
}

function presetRange(type) {
  const today = new Date();
  let from = new Date();
  let to   = new Date();

  if (type === "today") {
    // from = to = today
  }
  else if (type === "week") {
    const d = today.getDay();
    from.setDate(today.getDate() - d + 1);
  }
  else if (type === "month") {
    from = new Date(today.getFullYear(), today.getMonth(), 1);
  }
  else if (type === "quarter") {
    const q = Math.floor(today.getMonth() / 3);
    from = new Date(today.getFullYear(), q * 3, 1);
  }

  document.getElementById("fromDate").value = from.toISOString().substr(0, 10);
  document.getElementById("toDate").value   = to.toISOString().substr(0, 10);

  loadRangeStats();
}
</script>


  <!-- Footer -->
  <div class="text-center text-sm text-slate-500 mt-8">
    <p>üöó H·ªá th·ªëng qu·∫£n l√Ω c·ª≠a h√†ng s·ª≠a xe m√°y</p>
    <p class="mt-1">¬© 2025 - ƒê·ªì √°n chuy√™n ng√†nh</p>
  </div>

</div>


<!-- SAFE JSON PASSING -->
<div id="chart-data"
     data-labels='<%- JSON.stringify(advanced.monthly.map(function(m){ return m.month })) %>'
     data-values='<%- JSON.stringify(advanced.monthly.map(function(m){ return m.revenue })) %>'>
</div>


<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // L·∫•y data an to√†n t·ª´ HTML attribute
  const el = document.getElementById("chart-data");

  const revenueLabels = JSON.parse(el.dataset.labels);
  const revenueData   = JSON.parse(el.dataset.values);

  new Chart(document.getElementById("revenueChart"), {
    type: "line",
    data: {
      labels: revenueLabels,
      datasets: [{
        label: "Doanh thu (‚Ç´)",
        data: revenueData,
        borderWidth: 3,
        tension: 0.3,
      }],
    },
  });
</script>
